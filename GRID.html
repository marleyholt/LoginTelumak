<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grid de Batalha | MogerFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        #board-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 80px);
            background-color: #111827;
            overflow: hidden;
            touch-action: none; 
        }
        
        #map-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: contain; 
            z-index: 1;
        }

        #grid-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2;
            pointer-events: none; 
            background-image: 
                linear-gradient(to right, rgba(255,255,255,0.15) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,0.15) 1px, transparent 1px);
        }

        .token {
            position: absolute;
            z-index: 10;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.8);
            background-color: #374151;
            background-size: cover;
            background-position: center;
            transition: transform 0.1s;
            cursor: grab;
            display: flex; justify-content: center; align-items: center;
            color: white; font-weight: bold; font-size: 0.8rem; text-shadow: 1px 1px 2px black;
        }

        .token:active { cursor: grabbing; transform: scale(1.1); z-index: 50; }
        .token.aliado { border-color: #3b82f6; } 
        .token.monstro { border-color: #ef4444; } 

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilos do Or√°culo do Destino */
        .fab-dice { position: fixed; bottom: 20px; right: 20px; z-index: 40; transition: transform 0.2s; animation: float 3s ease-in-out infinite;}
        .fab-dice:hover { transform: scale(1.1); }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }

        @keyframes chaosShake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .rolling-chaos { animation: chaosShake 0.1s infinite; color: #94a3b8; }
        .result-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans overflow-hidden">

    <script>
        const API_GRID_URL = "https://script.google.com/macros/s/AKfycbxjLH9IOqox870iWhsQVWElsE8RSodeaMufpoU2nFaRpkcF_SmqFpLMg2HKNQEjr24/exec"; 
        const API_FICHAS_URL = "https://script.google.com/macros/s/AKfycbxw4VQm5jkVNbkhc-9Q2W8RcdYKHARTrTj0tRb0eKe8ujslyM8NNEwNHhu-wxgPsu9zSw/exec"; 
        const SALA_VOZ = "Telumak RPG";
    </script>

    <!-- HEADER / MENU SUPERIOR -->
    <header class="bg-gray-800 h-[80px] border-b border-gray-700 flex justify-between items-center px-4 relative z-50 shadow-md">
        <div class="flex items-center gap-3">
            <h1 class="text-lg font-bold text-emerald-500 hidden md:block">
                <i class="fas fa-chess-board mr-2"></i>Mesa T√°tica
            </h1>
            
            <span id="playerIdentifier" class="bg-gray-900 px-3 py-1 rounded-full text-xs text-gray-400 border border-gray-700">
                <i class="fas fa-user mr-1"></i> <span id="lblUserName">Carregando...</span>
            </span>
            
            <!-- CONTROLES EXCLUSIVOS DO GM -->
            <div id="gmControls" class="hidden flex items-center gap-2 border-l border-gray-700 pl-3 ml-2">
                <button onclick="document.getElementById('mapUpload').click()" class="bg-indigo-700 hover:bg-indigo-600 px-3 py-2 rounded text-xs font-bold text-white shadow" title="Trocar Mapa">
                    <i class="fas fa-image mr-1"></i> Fundo
                </button>
                <input type="file" id="mapUpload" accept="image/*" class="hidden" onchange="carregarImagemLocal(this, 'mapa')">
                
                <button onclick="limparFundo()" class="bg-red-800 hover:bg-red-700 px-3 py-2 rounded text-xs font-bold text-white shadow" title="Excluir Imagem de Fundo">
                    <i class="fas fa-trash-alt"></i>
                </button>

                <button onclick="abrirModalAddToken()" class="bg-emerald-700 hover:bg-emerald-600 px-3 py-2 rounded text-xs font-bold text-white shadow ml-2" title="Adicionar Token">
                    <i class="fas fa-chess-knight mr-1"></i> Add
                </button>

                <!-- NOVO BOT√ÉO: GERENCIAR TOKENS -->
                <button onclick="abrirModalGerenciarTokens()" class="bg-gray-600 hover:bg-gray-500 px-3 py-2 rounded text-xs font-bold text-white shadow" title="Lista de Tokens e Exclus√£o">
                    <i class="fas fa-list-ul mr-1"></i> Lista
                </button>
                
                <button onclick="configurarGrid()" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-xs font-bold text-white shadow ml-2" title="Configurar SQMs (Tamanho do Grid)">
                    <i class="fas fa-th mr-1"></i> Grid
                </button>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <span id="syncStatus" class="text-xs text-yellow-500 font-bold hidden md:inline"><i class="fas fa-spinner fa-spin mr-1"></i>Conectando...</span>
            
            <button onclick="toggleVoice()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded text-xs transition border border-blue-500 shadow-lg ml-2">
                <i class="fas fa-headset mr-1"></i> Voz
            </button>

            <button onclick="abrirFicha()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded text-xs transition border border-gray-600" title="Ver Ficha Completa">
                <i class="fas fa-address-card mr-1"></i> Ficha
            </button>

            <button onclick="window.close()" class="bg-red-900 hover:bg-red-800 text-white px-3 py-2 rounded text-xs transition border border-red-700" title="Fechar Grid">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </header>

    <!-- √ÅREA PRINCIPAL DO MAPA -->
    <div id="board-container">
        <img id="map-bg" src="https://via.placeholder.com/1920x1080/111827/374151?text=Aguardando+Sincronizacao..." alt="Fundo">
        <div id="grid-overlay"></div>
    </div>

    <!-- BOT√ÉO FLUTUANTE DE DADOS (FAB) -->
    <button onclick="toggleDiceModal()" class="fab-dice bg-yellow-700 hover:bg-yellow-600 text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center text-3xl border-4 border-slate-800">
        <i class="fas fa-dice-d20"></i>
    </button>

    <!-- MODAL: LISTA DE TOKENS (PARA EXCLUS√ÉO) -->
    <div id="modalManageTokens" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[60]">
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-2xl w-96 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h2 class="text-xl font-bold text-white"><i class="fas fa-list-ul mr-2"></i>Gerenciar Tokens</h2>
                <button onclick="fecharModalGerenciarTokens()" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            </div>
            
            <p class="text-xs text-gray-400 mb-4">Selecione um token abaixo para remov√™-lo da mesa.</p>

            <div id="listaTokensExcluir" class="flex-1 overflow-y-auto space-y-2 pr-2">
                <!-- A lista de tokens ser√° injetada aqui -->
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-700 flex justify-end">
                <button onclick="fecharModalGerenciarTokens()" class="px-6 py-2 bg-gray-600 hover:bg-gray-500 rounded text-white font-bold text-sm shadow">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DO OR√ÅCULO DO DESTINO -->
    <div id="diceModal" class="fixed inset-0 bg-black/95 backdrop-blur-sm hidden items-center justify-center z-[100] fade-in">
        <div class="bg-black w-full max-w-md rounded-2xl shadow-2xl border border-slate-800 p-6 relative flex flex-col max-h-[90vh]">
            <button onclick="toggleDiceModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white transition"><i class="fas fa-times fa-lg"></i></button>
            <h3 class="text-slate-400 font-bold text-xs tracking-[0.3em] uppercase text-center mb-6"><i class="fas fa-dice-d20 mr-2"></i>Or√°culo do Destino</h3>

            <div class="bg-slate-900/50 p-6 rounded-2xl mb-6 text-center border border-slate-800 flex flex-col justify-center items-center min-h-[140px] relative overflow-hidden shrink-0">
                <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-800/30 via-transparent to-transparent"></div>
                <div id="diceResultMain" class="text-7xl font-['Cinzel'] font-bold text-slate-600 relative z-10 transition-all">-</div>
                <div id="diceResultDetail" class="text-[10px] text-slate-400 mt-3 font-mono tracking-widest uppercase break-words w-full px-2 relative z-10 min-h-[1.5rem]">Aguardando Rolagem</div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4 shrink-0">
                <button onclick="rollSystem(1, 0)" class="bg-slate-800 hover:bg-slate-700 text-white font-['Cinzel'] font-bold py-3 rounded-xl border border-slate-700 hover:border-yellow-600 transition-all group shadow">
                    <span class="text-yellow-500 block text-xs tracking-widest mb-1">DESTINO</span>
                    1d10
                </button>
                <button onclick="rollSystem(4, 0)" class="bg-slate-800 hover:bg-slate-700 text-white font-['Cinzel'] font-bold py-3 rounded-xl border border-slate-700 hover:border-yellow-600 transition-all group shadow">
                    <span class="text-yellow-500 block text-xs tracking-widest mb-1">ATRIBUTOS</span>
                    4d10
                </button>
            </div>

            <div class="bg-slate-900/30 rounded-xl p-3 border border-slate-800/50 mb-4 shrink-0">
                <label class="block text-[9px] text-slate-500 uppercase tracking-widest mb-2 text-center">Rolagem Customizada</label>
                <form onsubmit="handleCustomRoll(event)" class="flex gap-2">
                    <input type="number" id="inputQtd" placeholder="Qtd (Ex: 5)" class="w-1/3 bg-black border border-slate-700 rounded px-3 py-2 text-white text-center focus:border-yellow-500 outline-none font-mono" required>
                    <span class="text-slate-500 self-center">d10 +</span>
                    <input type="number" id="inputMod" placeholder="B√¥nus (Ex: 10)" class="w-1/3 bg-black border border-slate-700 rounded px-3 py-2 text-white text-center focus:border-yellow-500 outline-none font-mono">
                    <button type="submit" class="bg-yellow-700 hover:bg-yellow-600 text-white px-4 rounded border border-yellow-600 font-bold transition"><i class="fas fa-play"></i></button>
                </form>
                <p class="text-[9px] text-slate-600 mt-2 text-center italic">*Cr√≠ticos (10) explodem uma vez.</p>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col border-t border-slate-800 pt-4">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-[10px] text-slate-500 uppercase tracking-widest font-bold"><i class="fas fa-scroll mr-1"></i> Hist√≥rico Global</h4>
                    <button id="btnLimparHist" onclick="acaoLimparHistorico()" class="hidden text-[9px] text-red-500 hover:text-red-400 font-bold border border-red-900/30 px-2 py-1 rounded bg-red-900/10 uppercase transition"><i class="fas fa-trash"></i> Limpar</button>
                </div>
                <div id="listaHistorico" class="flex-1 overflow-y-auto bg-slate-900/20 rounded border border-slate-800 p-2 space-y-2 scrollbar-hide" style="min-height: 120px;">
                    <div class="text-center text-slate-600 text-[10px] italic py-4">Carregando...</div>
                </div>
                <button onclick="carregarHistorico()" class="w-full text-center text-[9px] text-slate-600 hover:text-slate-400 mt-2 cursor-pointer">Atualizar Hist√≥rico</button>
            </div>
        </div>
    </div>


    <!-- MODAL: ADD TOKEN COM UPLOAD E TAMANHO -->
    <div id="modalAddToken" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[60]">
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-2xl w-96">
            <h2 class="text-xl font-bold text-white mb-4"><i class="fas fa-user-plus mr-2"></i>Novo Token</h2>
            
            <label class="block text-xs text-gray-400 mb-1">Nome / Iniciais</label>
            <input type="text" id="tkNome" placeholder="Ex: Orc 1" class="w-full bg-gray-900 border border-gray-600 rounded p-2 mb-3 text-white">
            
            <div class="grid grid-cols-2 gap-2 mb-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Tipo de Borda</label>
                    <select id="tkTipo" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white">
                        <option value="aliado">Aliado (Azul)</option>
                        <option value="monstro">Monstro (Vermelho)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Tamanho (SQM)</label>
                    <select id="tkTamanho" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white font-bold">
                        <option value="1">1x1 (Padr√£o)</option>
                        <option value="2">2x2 (Grande)</option>
                        <option value="3">3x3 (Enorme)</option>
                        <option value="4">4x4 (Colossal)</option>
                    </select>
                </div>
            </div>

            <div class="bg-gray-900 p-3 rounded border border-gray-700 mb-4 text-center">
                <label class="block text-xs text-gray-400 mb-2">Imagem do Token (Opcional)</label>
                <button onclick="document.getElementById('tokenUpload').click()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded text-xs">
                    <i class="fas fa-upload mr-1"></i> Escolher Imagem
                </button>
                <input type="file" id="tokenUpload" accept="image/*" class="hidden" onchange="carregarImagemLocal(this, 'token')">
                <div class="mt-3 flex justify-center hidden" id="tokenPreviewContainer">
                    <img id="tokenPreview" src="" class="w-12 h-12 rounded-full border-2 border-indigo-500 object-cover">
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-2">
                <button onclick="fecharModalAddToken()" class="px-4 py-2 text-gray-400 hover:text-white text-sm">Cancelar</button>
                <button onclick="criarToken()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-white font-bold shadow text-sm">Adicionar √† Mesa</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CANAL DE VOZ -->
    <div id="modalVoice" class="fixed bottom-4 left-4 z-[80] hidden flex-col w-80 h-96 bg-gray-900 rounded-xl shadow-2xl border border-blue-600 overflow-hidden resize">
        <div class="bg-blue-900 text-white p-2 flex justify-between items-center text-sm font-bold cursor-move" id="voiceHeader">
            <span><i class="fas fa-headset mr-2"></i>Comunica√ß√£o (Voz)</span>
            <button onclick="toggleVoice()" class="text-blue-200 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 w-full h-full bg-black relative" id="jitsiContainer">
            <div class="absolute inset-0 flex items-center justify-center text-gray-500 text-xs text-center p-4">
                Clique para conectar ao canal de voz.<br><br>
                <button onclick="conectarVoz()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded">Conectar</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // --- ESTADO GLOBAL ---
        let USER_ROLE = "PLAYER"; 
        let USER_NAME = "";
        
        let boardState = {
            mapImage: "",
            cols: 20, 
            rows: 15, 
            tokens: []
        };

        let tokenTempImageBase64 = null;
        let draggingToken = null;
        let startX = 0, startY = 0;
        let tokenStartX = 0, tokenStartY = 0;
        let syncInterval = null;

        // --- 1. INICIALIZA√á√ÉO VIA URL E MEM√ìRIA ---
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            let isGM = urlParams.get('gm') === 'true';
            let playerNameViaSession = "";
            
            const sessao = localStorage.getItem('moger_session');
            if(sessao) {
                try {
                    const dados = JSON.parse(sessao);
                    if(dados.role && dados.role.toUpperCase() === 'GM') isGM = true;
                    if(dados.charData && dados.charData.nome) playerNameViaSession = dados.charData.nome;
                } catch(e) {}
            }

            if (isGM) {
                USER_ROLE = "GM"; USER_NAME = "Mestre";
                document.getElementById('gmControls').classList.remove('hidden');
                document.getElementById('gmControls').classList.add('flex');
            } else if (urlParams.get('player')) {
                USER_ROLE = "PLAYER"; USER_NAME = urlParams.get('player');
            } else if (playerNameViaSession) {
                USER_ROLE = "PLAYER"; USER_NAME = playerNameViaSession;
            } else {
                USER_NAME = "Espectador";
            }

            document.getElementById('lblUserName').innerText = USER_NAME;
            atualizarCSSGrid();
            iniciarPolling();
        };

        // --- 2. COMUNICA√á√ÉO ATIVA (GRID) ---
        function iniciarPolling() {
            const timer = USER_ROLE === "GM" ? 8000 : 3000; 
            fazerLeituraGrid();
            syncInterval = setInterval(fazerLeituraGrid, timer);
        }

        async function fazerLeituraGrid() {
            if (draggingToken) return;
            const statusEl = document.getElementById('syncStatus');
            try {
                if (API_GRID_URL.includes("SUA_URL")) return;

                const response = await fetch(API_GRID_URL + "?acao=LER_GRID");
                if(!response.ok) throw new Error("Erro na rede.");
                
                const dadosNuvem = await response.json();
                
                if (dadosNuvem && dadosNuvem.cols) {
                    boardState = dadosNuvem;
                    atualizarCSSGrid();
                    renderizarTokens();
                    statusEl.innerHTML = '<i class="fas fa-wifi text-emerald-500"></i> Online';
                }
            } catch (e) {
                if(e.message.includes("Failed to fetch")) {
                    statusEl.innerHTML = '<i class="fas fa-lock text-red-500"></i> Acesso Negado';
                } else {
                    statusEl.innerHTML = '<i class="fas fa-unlink text-red-500"></i> Offline';
                }
            }
        }

        async function salvarGridNoBackend() {
            if(USER_ROLE !== "GM") return;
            const statusEl = document.getElementById('syncStatus');
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin text-yellow-500"></i> Salvando...';
            try {
                if (API_GRID_URL.includes("SUA_URL")) return;
                await fetch(API_GRID_URL, {
                    method: 'POST', mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ acao: "ATUALIZAR_GRID", estado: boardState })
                });
                statusEl.innerHTML = '<i class="fas fa-check text-emerald-500"></i> Salvo';
                setTimeout(() => { statusEl.innerHTML = '<i class="fas fa-wifi text-emerald-500"></i> Online'; }, 2000);
            } catch (e) {
                statusEl.innerHTML = '<i class="fas fa-times text-red-500"></i> Erro Save';
            }
        }

        // --- 3. UPLOAD DE IMAGENS E COMPRESS√ÉO EXTREMA ---
        function carregarImagemLocal(input, tipo) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let MAX_WIDTH = tipo === 'token' ? 100 : 800;
                    let qualidade = tipo === 'token' ? 0.8 : 0.4;
                    
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    let base64Str = canvas.toDataURL('image/jpeg', qualidade);

                    if (tipo === 'mapa') {
                        let tentativas = 0;
                        while(base64Str.length > 45000 && tentativas < 5) {
                            qualidade -= 0.1;
                            canvas.width = canvas.width * 0.8; 
                            canvas.height = canvas.height * 0.8;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            base64Str = canvas.toDataURL('image/jpeg', Math.max(0.1, qualidade));
                            tentativas++;
                        }
                        
                        if(base64Str.length > 48000) {
                            alert("‚ö†Ô∏è A imagem √© extremamente complexa e pesada. Por favor, recorte-a ou use uma imagem mais simples.");
                            return;
                        }

                        boardState.mapImage = base64Str;
                        atualizarCSSGrid();
                        salvarGridNoBackend();
                    } else if (tipo === 'token') {
                        tokenTempImageBase64 = base64Str;
                        document.getElementById('tokenPreview').src = base64Str;
                        document.getElementById('tokenPreviewContainer').classList.remove('hidden');
                    }
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        function limparFundo() {
            if(confirm("Deseja remover a imagem do mapa?")) {
                boardState.mapImage = "";
                atualizarCSSGrid();
                salvarGridNoBackend();
            }
        }

        // --- 4. L√ìGICA DO GRID, TOKENS E EXCLUS√ÉO EM LISTA ---
        function abrirModalGerenciarTokens() {
            renderListaExcluir();
            document.getElementById('modalManageTokens').classList.remove('hidden');
            document.getElementById('modalManageTokens').classList.add('flex');
        }

        function fecharModalGerenciarTokens() {
            document.getElementById('modalManageTokens').classList.add('hidden');
            document.getElementById('modalManageTokens').classList.remove('flex');
        }

        function renderListaExcluir() {
            const container = document.getElementById('listaTokensExcluir');
            container.innerHTML = "";

            if (boardState.tokens.length === 0) {
                container.innerHTML = "<p class='text-gray-500 text-sm italic text-center py-4'>Nenhum token na mesa.</p>";
                return;
            }

            boardState.tokens.forEach(tk => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-gray-900 p-3 rounded border border-gray-700";
                
                let iconColor = tk.tipo === 'aliado' ? 'text-blue-500' : 'text-red-500';
                let imgSrc = tk.imgUrl ? `<img src="${tk.imgUrl}" class="w-8 h-8 rounded-full border border-gray-500 object-cover">` : `<div class="w-8 h-8 rounded-full border border-gray-500 flex items-center justify-center bg-gray-700 text-xs font-bold text-white">${tk.nome.substring(0,2).toUpperCase()}</div>`;

                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        ${imgSrc}
                        <div class="flex flex-col">
                            <span class="text-white text-sm font-bold truncate">${tk.nome}</span>
                            <span class="text-[10px] uppercase tracking-widest ${iconColor}">${tk.tipo}</span>
                        </div>
                    </div>
                    <button onclick="excluirTokenId('${tk.id}')" class="bg-red-800 hover:bg-red-700 text-white p-2 rounded shadow transition" title="Excluir Token">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function excluirTokenId(id) {
            if(!confirm("Tem certeza que deseja remover este token?")) return;
            boardState.tokens = boardState.tokens.filter(t => t.id !== id);
            renderListaExcluir(); // Atualiza a lista internamente
            renderizarTokens();   // Remove visualmente da tela
            salvarGridNoBackend(); // Salva na nuvem
        }

        function abrirModalAddToken() {
            tokenTempImageBase64 = null;
            document.getElementById('tokenPreviewContainer').classList.add('hidden');
            document.getElementById('tkNome').value = "";
            document.getElementById('tkTamanho').value = "1";
            document.getElementById('modalAddToken').classList.remove('hidden');
            document.getElementById('modalAddToken').classList.add('flex');
        }

        function fecharModalAddToken() {
            document.getElementById('modalAddToken').classList.add('hidden');
            document.getElementById('modalAddToken').classList.remove('flex');
        }

        function criarToken() {
            const nome = document.getElementById('tkNome').value || "TK";
            const tipo = document.getElementById('tkTipo').value;
            const tamanho = parseInt(document.getElementById('tkTamanho').value) || 1; 
            
            boardState.tokens.push({
                id: 'tk_' + Date.now(),
                nome: nome,
                tipo: tipo,
                size: tamanho,
                imgUrl: tokenTempImageBase64,
                x: Math.floor(boardState.cols / 2),
                y: Math.floor(boardState.rows / 2)
            });

            fecharModalAddToken();
            renderizarTokens();
            salvarGridNoBackend();
        }

        function atualizarCSSGrid() {
            const overlay = document.getElementById('grid-overlay');
            if (overlay) {
                overlay.style.backgroundSize = `${100 / boardState.cols}% ${100 / boardState.rows}%`;
            }
            
            if(boardState.mapImage) {
                document.getElementById('map-bg').src = boardState.mapImage;
            } else {
                document.getElementById('map-bg').src = "https://via.placeholder.com/1920x1080/111827/374151?text=Aguardando+GM+enviar+o+Mapa";
            }
        }

        function renderizarTokens() {
            const container = document.getElementById('board-container');
            document.querySelectorAll('.token').forEach(e => e.remove());

            boardState.tokens.forEach(tk => {
                const el = document.createElement('div');
                el.className = `token ${tk.tipo}`;
                el.id = tk.id;
                
                if(tk.imgUrl) {
                    el.style.backgroundImage = `url(${tk.imgUrl})`;
                    el.innerText = "";
                } else {
                    el.innerText = tk.nome.substring(0, 2).toUpperCase();
                }
                
                const size = tk.size || 1; 
                
                const leftPct = (tk.x / boardState.cols) * 100;
                const topPct = (tk.y / boardState.rows) * 100;
                
                el.style.width = `calc(${(100 / boardState.cols) * size}% - 4px)`;
                el.style.height = `calc(${(100 / boardState.rows) * size}% - 4px)`;
                el.style.left = `calc(${leftPct}% + 2px)`;
                el.style.top = `calc(${topPct}% + 2px)`;

                if (USER_ROLE === "GM") {
                    el.addEventListener('mousedown', dragStart);
                    el.addEventListener('touchstart', dragStart, {passive: false});
                }
                container.appendChild(el);
            });
        }

        // --- ARRASTAR (DRAG & DROP) OTIMIZADO (Sem lixeira) ---
        function dragStart(e) {
            if(USER_ROLE !== "GM") return;
            e.preventDefault();
            draggingToken = e.target;
            const event = e.type === 'touchstart' ? e.touches[0] : e;
            startX = event.clientX; startY = event.clientY;
            tokenStartX = parseFloat(draggingToken.style.left); tokenStartY = parseFloat(draggingToken.style.top);

            document.addEventListener('mousemove', dragMove);
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('touchmove', dragMove, {passive: false});
            document.addEventListener('touchend', dragEnd);
        }

        function dragMove(e) {
            if (!draggingToken) return;
            e.preventDefault();
            const event = e.type === 'touchmove' ? e.touches[0] : e;
            const dx = event.clientX - startX; const dy = event.clientY - startY;
            draggingToken.style.left = `calc(${tokenStartX}px + ${dx}px)`;
            draggingToken.style.top = `calc(${tokenStartY}px + ${dy}px)`;
        }

        function dragEnd(e) {
            document.removeEventListener('mousemove', dragMove); document.removeEventListener('mouseup', dragEnd);
            document.removeEventListener('touchmove', dragMove); document.removeEventListener('touchend', dragEnd);
            if (!draggingToken) return;

            const event = e.type === 'touchend' ? e.changedTouches[0] : e;
            const clientX = event.clientX; const clientY = event.clientY;
            
            const container = document.getElementById('board-container');
            const rect = container.getBoundingClientRect();
            const mouseX = clientX - rect.left; const mouseY = clientY - rect.top;
            const cellW = rect.width / boardState.cols; const cellH = rect.height / boardState.rows;

            let newX = Math.floor(mouseX / cellW); let newY = Math.floor(mouseY / cellH);
            newX = Math.max(0, Math.min(newX, boardState.cols - 1));
            newY = Math.max(0, Math.min(newY, boardState.rows - 1));

            const tkData = boardState.tokens.find(t => t.id === draggingToken.id);
            if(tkData) { tkData.x = newX; tkData.y = newY; }

            draggingToken = null;
            renderizarTokens(); 
            salvarGridNoBackend();
        }

        function configurarGrid() {
            const dim = prompt("Dimens√µes (Colunas x Linhas). Ex: 20x15", `${boardState.cols}x${boardState.rows}`);
            if(dim && dim.includes('x')) {
                const parts = dim.split('x');
                boardState.cols = parseInt(parts[0]); boardState.rows = parseInt(parts[1]);
                atualizarCSSGrid(); renderizarTokens(); salvarGridNoBackend();
            }
        }

        // --- 5. FICHA COMPLETA ---
        function abrirFicha() {
            if(USER_ROLE === "GM") { window.open('gm_login.html', '_blank'); } else { window.open('index.html', '_blank'); }
        }

        // ==========================================
        // 6. SISTEMA DE DADOS (OR√ÅCULO)
        // ==========================================
        function toggleDiceModal() {
            const m = document.getElementById('diceModal');
            m.classList.toggle('hidden'); m.classList.toggle('flex');
            if(!m.classList.contains('hidden')){
                resetDisplayDice();
                if (USER_ROLE === 'GM') document.getElementById('btnLimparHist').classList.remove('hidden');
                carregarHistorico(); 
            }
        }

        function resetDisplayDice() {
            const main = document.getElementById('diceResultMain');
            main.className = "text-7xl font-['Cinzel'] font-bold text-slate-600 relative z-10";
            main.innerText = "-";
            document.getElementById('diceResultDetail').innerText = "Aguardando Rolagem";
        }

        function handleCustomRoll(e) {
            e.preventDefault();
            const qtd = parseInt(document.getElementById('inputQtd').value) || 0;
            const mod = parseInt(document.getElementById('inputMod').value) || 0;
            if (qtd > 0) rollSystem(qtd, mod);
        }

        function rollSystem(qtdDados, modificador) {
            const main = document.getElementById('diceResultMain');
            const detail = document.getElementById('diceResultDetail');
            main.className = "text-7xl font-['Cinzel'] font-bold rolling-chaos relative z-10";
            detail.innerText = `ROLANDO ${qtdDados}d10 + ${modificador}...`;
            detail.className = "text-xs text-slate-500 mt-3 font-mono tracking-widest uppercase relative z-10 animate-pulse";
            let intervals = 0;
            const anim = setInterval(() => {
                main.innerText = Math.floor(Math.random() * (qtdDados * 10)) + modificador;
                intervals++;
                if (intervals >= 12) { clearInterval(anim); calcularResultadoReal(qtdDados, modificador); }
            }, 60);
        }

        function calcularResultadoReal(qtd, mod) {
            let total = 0; let rolagens = []; let criticos = 0; let falhas = 0;
            for (let i = 0; i < qtd; i++) {
                let dado = Math.floor(Math.random() * 10) + 1;
                let infoDado = { base: dado, extra: 0 };
                total += dado;
                if (dado === 10) {
                    criticos++; let extra = Math.floor(Math.random() * 10) + 1;
                    total += extra; infoDado.extra = extra;
                    if (extra === 10) criticos++; if (extra === 1) falhas++;    
                } else if (dado === 1) falhas++;
                rolagens.push(infoDado);
            }
            total += mod; exibirResultado(total, rolagens, mod, criticos);
        }

        function exibirResultado(total, rolagens, mod, numCriticos) {
            const main = document.getElementById('diceResultMain');
            const detail = document.getElementById('diceResultDetail');
            main.innerText = total; main.className = "text-7xl font-['Cinzel'] font-bold relative z-10 result-pop";
            if (numCriticos > 0) main.classList.add("text-emerald-400", "drop-shadow-[0_0_15px_rgba(52,211,153,0.8)]");
            else main.classList.add("text-white", "drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]");

            let strDetalhe = "[ ";
            strDetalhe += rolagens.map(r => {
                if (r.extra > 0) return `<span class="text-emerald-400 font-bold border-b border-emerald-500">${r.base}+${r.extra}</span>`;
                else if (r.base === 1) return `<span class="text-red-500">${r.base}</span>`;
                else return `<span class="text-slate-300">${r.base}</span>`;
            }).join(", ");
            strDetalhe += " ]" + (mod !== 0 ? ` + <span class="text-yellow-500">${mod}</span>` : "");
            detail.innerHTML = strDetalhe; detail.className = "text-[10px] text-slate-400 mt-3 font-mono leading-relaxed break-words w-full px-4 relative z-10";
            
            let textoLog = `${rolagens.length}d10${mod >= 0 ? '+'+mod : mod} >> ${total}`;
            if (numCriticos > 0) textoLog += " üî•"; 
            enviarLogRolagem(textoLog);
        } 

        async function enviarLogRolagem(textoResultado) {
            try {
                await fetch(API_FICHAS_URL, { method: 'POST', body: JSON.stringify({ action: "registrarRolagem", usuario: USER_NAME, resumo: textoResultado }) });
                carregarHistorico();
            } catch (e) { console.error("Erro", e); }
        }

        async function carregarHistorico() {
            const div = document.getElementById('listaHistorico');
            div.innerHTML = '<div class="text-center text-slate-600 text-[10px] italic py-4"><i class="fas fa-circle-notch fa-spin"></i> Buscando...</div>';
            try {
                const response = await fetch(API_FICHAS_URL, { method: 'POST', body: JSON.stringify({ action: "lerHistorico" }) });
                const data = await response.json();
                div.innerHTML = ""; 
                if (data.status === "SUCESSO" && data.logs && data.logs.length > 0) {
                    data.logs.forEach(log => {
                        const dObj = new Date(log.data); const hora = !isNaN(dObj) ? dObj.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) : "--:--";
                        div.innerHTML += `<div class="border-b border-slate-800/50 pb-1 mb-1 last:border-0"><div class="flex justify-between text-[9px] text-slate-500"><span class="font-bold text-slate-400">${log.quem || log.jogador || "Desconhecido"}</span><span>${hora}</span></div><div class="text-emerald-400 text-xs font-mono font-bold leading-tight mt-1">${log.resultado}</div></div>`;
                    });
                } else div.innerHTML = '<div class="text-center text-slate-600 text-[10px] italic py-4">Sem registros recentes.</div>';
            } catch (e) { div.innerHTML = '<div class="text-center text-red-500 text-[10px] py-4">Erro de conex√£o.</div>'; }
        }

        async function acaoLimparHistorico() {
            if(!confirm("MESTRE: Tem certeza que deseja apagar todo o hist√≥rico de rolagens global?")) return;
            const btn = document.getElementById('btnLimparHist'); const textoOriginal = btn.innerHTML; btn.innerHTML = "Apagando...";
            try {
                await fetch(API_FICHAS_URL, { method: 'POST', body: JSON.stringify({ action: "limparHistorico" }) });
                carregarHistorico();
            } catch(e) { alert("Erro ao conectar com servidor."); } finally { btn.innerHTML = textoOriginal; }
        }

        // --- 7. CANAL DE VOZ ---
        let vozAtiva = false;
        function toggleVoice() {
            const modal = document.getElementById('modalVoice');
            modal.classList.toggle('hidden'); modal.classList.toggle('flex');
        }

        function conectarVoz() {
            const container = document.getElementById('jitsiContainer');
            container.innerHTML = `<iframe allow="camera; microphone; fullscreen; display-capture; autoplay" src="https://meet.jit.si/${SALA_VOZ}#config.prejoinPageEnabled=false&userInfo.displayName=${USER_NAME}" style="width: 100%; height: 100%; border: none;"></iframe>`;
            vozAtiva = true;
        }

        const voiceHeader = document.getElementById('voiceHeader');
        const voiceModal = document.getElementById('modalVoice');
        let isDraggingVoice = false, vX = 0, vY = 0, mX = 0, mY = 0;
        voiceHeader.onmousedown = (e) => {
            e.preventDefault(); isDraggingVoice = true; mX = e.clientX; mY = e.clientY;
            document.onmousemove = (e2) => {
                if(!isDraggingVoice) return; e2.preventDefault();
                vX = mX - e2.clientX; vY = mY - e2.clientY; mX = e2.clientX; mY = e2.clientY;
                voiceModal.style.top = (voiceModal.offsetTop - vY) + "px";
                voiceModal.style.left = (voiceModal.offsetLeft - vX) + "px";
                voiceModal.style.bottom = 'auto'; 
            };
            document.onmouseup = () => { isDraggingVoice = false; document.onmousemove = null; document.onmouseup = null; };
        };
    </script>
</body>
</html>