<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telumak RPG | Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root { --color-bg: #0f172a; --color-card: #1e293b; --color-text: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-bg); color: var(--color-text); overflow-x: hidden; }
        h1, h2, h3, .rpg-font { font-family: 'Cinzel', serif; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Barras */
        .bar-container { background: rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden; height: 20px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); position: relative; }
        .bar-fill { height: 100%; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; font-size: 0.7rem; font-weight: bold; text-shadow: 1px 1px 2px black; }
        .hp-fill { background: linear-gradient(90deg, #991b1b, #ef4444); }
        .ether-fill { background: linear-gradient(90deg, #1e3a8a, #3b82f6); }
        .destino-fill { background: linear-gradient(90deg, #ca8a04, #facc15); }

        /* Conteúdo Rico */
        .html-content strong { color: #818cf8; } .html-content b { color: #f472b6; }

        /* Dados e FAB */
        .fab-dice { position: fixed; bottom: 20px; right: 20px; z-index: 50; transition: transform 0.2s; animation: float 3s ease-in-out infinite; }
        .fab-dice:hover { transform: scale(1.1); }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        .dice-result-crit { color: #4ade80; text-shadow: 0 0 10px #22c55e; }
        .dice-result-fumble { color: #f87171; text-shadow: 0 0 10px #ef4444; }
        .dice-anim { animation: rollDiceAnim 0.5s ease-out; }
        @keyframes rollDiceAnim { 0% { transform: rotate(0deg) scale(0.5); } 100% { transform: rotate(360deg) scale(1); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- CONFIG API -->
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxw4VQm5jkVNbkhc-9Q2W8RcdYKHARTrTj0tRb0eKe8ujslyM8NNEwNHhu-wxgPsu9zSw/exec";
    </script>

    <!-- LOGIN -->
    <div id="login-screen" class="flex-grow flex items-center justify-center p-4 relative">
        <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1519074069444-1ba4fff66d16?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80')] bg-cover bg-center opacity-20"></div>
        <div class="bg-slate-900/90 backdrop-blur-md p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700 relative z-10 fade-in flex flex-col items-center">
            
            <!-- LOGO: Substitua pelo link direto se necessário -->
            <img src="LINK_DA_SUA_LOGO_AQUI.png" 
                 onerror="this.style.display='none'; document.getElementById('logo-fallback').classList.remove('hidden');"
                 alt="TELUMAK" class="h-24 mb-4 object-contain filter drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]">
            
            <i id="logo-fallback" class="fas fa-dragon text-6xl text-yellow-600 mb-4 hidden animate-pulse"></i>

            <h1 class="text-3xl text-yellow-600 font-bold mb-1 rpg-font tracking-widest">TELUMAK</h1>
            <p class="text-slate-400 text-sm mb-8">Acesso ao Grimório Digital</p>

            <form id="loginForm" onsubmit="handleLogin(event)" class="w-full">
                <div class="mb-4">
                    <label class="block text-slate-300 text-sm font-bold mb-2 ml-1">Email</label>
                    <input type="email" id="email" required class="w-full bg-slate-800 border border-slate-600 rounded-lg py-2 px-4 text-white focus:outline-none focus:border-yellow-600 transition shadow-inner">
                </div>
                <div class="mb-6">
                    <label class="block text-slate-300 text-sm font-bold mb-2 ml-1">Senha</label>
                    <input type="password" id="password" required class="w-full bg-slate-800 border border-slate-600 rounded-lg py-2 px-4 text-white focus:outline-none focus:border-yellow-600 transition shadow-inner">
                </div>
                <button type="submit" id="btnLogin" class="w-full bg-yellow-700 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg transition transform hover:scale-[1.02] shadow-lg flex justify-center items-center">
                    <span id="btnText">Entrar</span>
                    <i id="btnLoader" class="fas fa-circle-notch fa-spin ml-2 hidden"></i>
                </button>
            </form>
            <p id="msgErro" class="text-red-400 text-center text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="app-screen" class="hidden relative min-h-screen pb-20">
        <!-- Navbar -->
        <nav class="bg-slate-900 border-b border-slate-800 p-3 sticky top-0 z-40 shadow-lg flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="h-10 w-auto overflow-hidden flex items-center">
                    <span class="text-xl font-bold text-yellow-600 rpg-font tracking-widest border border-yellow-600/30 px-2 rounded bg-black/40">TELUMAK</span>
                </div>
                <div class="h-8 w-px bg-slate-700 mx-1"></div>
                <div>
                    <h2 id="charNameDisplay" class="text-lg font-bold text-white leading-tight">...</h2>
                    <p id="charClassDisplay" class="text-[10px] text-yellow-500 uppercase tracking-wider">...</p>
                </div>
            </div>
            <div class="flex gap-4">
                <button id="btnGMPanelNav" onclick="window.location.href='gm_login.html'" class="hidden text-indigo-400 hover:text-indigo-300 font-bold border border-indigo-500/50 px-3 py-1 rounded transition flex items-center gap-2">
                    <i class="fas fa-tools"></i> <span class="hidden md:inline">GM</span>
                </button>
                <button onclick="logout()" class="text-slate-400 hover:text-red-400 transition" title="Sair"><i class="fas fa-sign-out-alt text-xl"></i></button>
            </div>
        </nav>

        <main class="container mx-auto p-4 max-w-4xl space-y-6">
            
            <div id="updateAlert" onclick="aplicarAtualizacao()" class="hidden cursor-pointer bg-indigo-600 hover:bg-indigo-500 text-white p-3 rounded-lg shadow-lg animate-bounce text-center font-bold mb-4 border border-indigo-400">
                <i class="fas fa-sync-alt fa-spin mr-2"></i> ATUALIZAÇÃO DISPONÍVEL!
            </div>

            <!-- Status -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 shadow-lg">
                    <div class="flex justify-between items-end mb-1"><span class="text-slate-300 font-bold text-xs"><i class="fas fa-heart text-red-500 mr-1"></i> Vida</span><span id="hpText" class="text-white font-mono text-sm">0/0</span></div>
                    <div class="bar-container"><div id="hpBar" class="bar-fill hp-fill" style="width: 0%"></div></div>
                </div>
                <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 shadow-lg">
                    <div class="flex justify-between items-end mb-1"><span class="text-slate-300 font-bold text-xs"><i class="fas fa-bolt text-blue-500 mr-1"></i> Éter</span><span id="etherText" class="text-white font-mono text-sm">0/0</span></div>
                    <div class="bar-container"><div id="etherBar" class="bar-fill ether-fill" style="width: 0%"></div></div>
                </div>
                <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 shadow-lg">
                    <div class="flex justify-between items-end mb-1"><span class="text-slate-300 font-bold text-xs"><i class="fas fa-star text-yellow-500 mr-1"></i> Destino</span><span id="destinoText" class="text-white font-mono text-sm">0/0</span></div>
                    <div class="bar-container"><div id="destinoBar" class="bar-fill destino-fill" style="width: 0%"></div></div>
                </div>
            </div>

            <!-- Imagem e Atributos -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Imagem -->
                <div class="md:col-span-1">
                    <div class="relative aspect-[3/4] rounded-xl overflow-hidden shadow-2xl border-2 border-slate-700 group bg-black">
                        <img id="charImage" src="" 
                             onerror="this.src='https://via.placeholder.com/300x400?text=Link+Quebrado'; this.onerror=null;"
                             alt="Personagem" class="w-full h-full object-cover transition duration-500 group-hover:scale-105">
                        
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 p-4">
                            <span id="charLevel" class="bg-yellow-700 text-white text-xs px-2 py-1 rounded font-bold border border-yellow-500">Nível ?</span>
                        </div>
                    </div>
                </div>

                <!-- Atributos -->
                <div class="md:col-span-2 flex flex-col gap-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-800 p-3 rounded border border-slate-700 flex flex-col items-center justify-center">
                            <span class="text-slate-400 text-[10px] uppercase tracking-widest mb-1">Físico</span>
                            <span id="attrFisico" class="text-3xl font-bold text-white">0</span>
                        </div>
                        <div class="bg-slate-800 p-3 rounded border border-slate-700 flex flex-col items-center justify-center">
                            <span class="text-slate-400 text-[10px] uppercase tracking-widest mb-1">Destreza</span>
                            <span id="attrDestreza" class="text-3xl font-bold text-white">0</span>
                        </div>
                        <div class="bg-slate-800 p-3 rounded border border-slate-700 flex flex-col items-center justify-center">
                            <span class="text-slate-400 text-[10px] uppercase tracking-widest mb-1">Cognição</span>
                            <span id="attrCognicao" class="text-3xl font-bold text-white">0</span>
                        </div>
                        <div class="bg-slate-800 p-3 rounded border border-slate-700 flex flex-col items-center justify-center">
                            <span class="text-slate-400 text-[10px] uppercase tracking-widest mb-1">Carisma</span>
                            <span id="attrCarisma" class="text-3xl font-bold text-white">0</span>
                        </div>
                        <div class="col-span-2 bg-indigo-900/30 p-2 rounded border border-indigo-500/30 flex justify-between items-center px-4">
                            <span class="text-indigo-300 text-xs uppercase font-bold tracking-widest">Primórdio</span>
                            <span id="attrPrimordio" class="text-2xl font-bold text-indigo-400">0</span>
                        </div>
                    </div>

                    <!-- Ferramentas de Combate -->
                    <div class="bg-slate-900/50 rounded-lg border border-slate-700 p-3">
                        <h4 class="text-[10px] text-slate-500 uppercase font-bold mb-2 border-b border-slate-700 pb-1 flex items-center">
                            <i class="fas fa-tools mr-1"></i> Ferramentas de Combate
                        </h4>
                        <div class="grid grid-cols-4 gap-2 text-center">
                            <div class="bg-slate-800 rounded p-1">
                                <span class="block text-[9px] text-slate-400">Físico</span>
                                <span id="ferrFisico" class="text-xs font-mono text-green-400 font-bold">+0</span>
                            </div>
                            <div class="bg-slate-800 rounded p-1">
                                <span class="block text-[9px] text-slate-400">Destr.</span>
                                <span id="ferrDestreza" class="text-xs font-mono text-green-400 font-bold">+0</span>
                            </div>
                            <div class="bg-slate-800 rounded p-1">
                                <span class="block text-[9px] text-slate-400">Cogn.</span>
                                <span id="ferrCognicao" class="text-xs font-mono text-green-400 font-bold">+0</span>
                            </div>
                            <div class="bg-slate-800 rounded p-1">
                                <span class="block text-[9px] text-slate-400">Caris.</span>
                                <span id="ferrCarisma" class="text-xs font-mono text-green-400 font-bold">+0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Abas -->
            <div class="bg-slate-800 rounded-xl shadow-lg border border-slate-700 overflow-hidden">
                <div class="flex overflow-x-auto bg-slate-900/50 border-b border-slate-700">
                    <button onclick="switchTab('ataques')" class="tab-btn active px-6 py-4 text-sm font-bold text-indigo-400 border-b-2 border-indigo-500 whitespace-nowrap" data-tab="ataques">Ataques</button>
                    <button onclick="switchTab('dons')" class="tab-btn px-6 py-4 text-sm font-bold text-slate-400 hover:text-white border-b-2 border-transparent whitespace-nowrap" data-tab="dons">Dons</button>
                    <button onclick="switchTab('equip')" class="tab-btn px-6 py-4 text-sm font-bold text-slate-400 hover:text-white border-b-2 border-transparent whitespace-nowrap" data-tab="equip">Equipamento</button>
                    <button onclick="switchTab('defesa')" class="tab-btn px-6 py-4 text-sm font-bold text-slate-400 hover:text-white border-b-2 border-transparent whitespace-nowrap" data-tab="defesa">Defesa</button>
                </div>
                <div class="p-6 min-h-[200px]">
                    <div id="tab-ataques" class="tab-content fade-in html-content text-slate-300 text-sm leading-relaxed"></div>
                    <div id="tab-dons" class="tab-content hidden fade-in html-content text-slate-300 text-sm leading-relaxed"></div>
                    <div id="tab-equip" class="tab-content hidden fade-in html-content text-slate-300 text-sm leading-relaxed"></div>
                    <div id="tab-defesa" class="tab-content hidden fade-in html-content text-slate-300 text-sm leading-relaxed"></div>
                </div>
            </div>
            
            <div class="text-center text-slate-600 text-xs pb-8">Sistema TELUMAK</div>
        </main>
        
        <!-- FAB DICE -->
        <button onclick="toggleDiceModal()" class="fab-dice bg-yellow-700 hover:bg-yellow-600 text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center text-3xl border-4 border-slate-800">
            <i class="fas fa-dice-d20"></i>
        </button>

        <!-- MODAL DADOS -->
        <div id="diceModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 fade-in">
            <div class="bg-slate-800 w-full max-w-md rounded-xl shadow-2xl border border-slate-600 p-6 relative">
                <button onclick="toggleDiceModal()" class="absolute top-2 right-2 text-slate-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
                <h3 class="text-yellow-500 font-bold text-xl mb-4 text-center"><i class="fas fa-dice mr-2"></i>Rolador TELUMAK</h3>
                <div class="bg-slate-900 p-6 rounded-lg mb-4 text-center border border-slate-700 min-h-[120px] flex flex-col justify-center items-center relative overflow-hidden">
                    <i id="diceIconAnim" class="fas fa-dice-d20 text-6xl text-slate-700 absolute opacity-20"></i>
                    <div id="diceResultMain" class="text-5xl font-black text-white relative z-10">-</div>
                    <div id="diceResultDetail" class="text-sm text-slate-400 mt-2 relative z-10">Clique em um dado</div>
                </div>
                <form onsubmit="rollCustom(event)" class="flex gap-2 mb-4">
                    <input type="text" id="customRoll" placeholder="/roll 1d20+5" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white focus:border-yellow-500 outline-none text-sm font-mono">
                    <button type="submit" class="bg-yellow-700 hover:bg-yellow-600 px-4 rounded text-white font-bold"><i class="fas fa-paper-plane"></i></button>
                </form>
                <div class="grid grid-cols-4 gap-2 mb-4">
                    <button onclick="rollDice(20)" class="bg-slate-700 hover:bg-slate-600 p-2 rounded text-indigo-300 font-bold border border-slate-600">D20</button>
                    <button onclick="rollDice(12)" class="bg-slate-700 hover:bg-slate-600 p-2 rounded text-indigo-300 font-bold border border-slate-600">D12</button>
                    <button onclick="rollDice(10)" class="bg-slate-700 hover:bg-slate-600 p-2 rounded text-indigo-300 font-bold border border-slate-600">D10</button>
                    <button onclick="rollDice(8)" class="bg-slate-700 hover:bg-slate-600 p-2 rounded text-indigo-300 font-bold border border-slate-600">D8</button>
                    <button onclick="rollDice(6)" class="bg-slate-700 hover:bg-slate-600 p-2 rounded text-indigo-300 font-bold border border-slate-600">D6</button>
                    <button onclick="rollDice(4)" class="bg-slate-700 hover:bg-slate-600 p-2 rounded text-indigo-300 font-bold border border-slate-600">D4</button>
                    <button onclick="rollDice(100)" class="col-span-2 bg-slate-700 hover:bg-slate-600 p-2 rounded text-indigo-300 font-bold border border-slate-600">D100</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        let GLOBAL_USER_ROLE = "PLAYER";
        let GLOBAL_CURRENT_CHAR_EMAIL = "";
        let dadosAtuais = null;
        let dadosPendentes = null;
        let intervaloMonitor = null;

        document.addEventListener('DOMContentLoaded', checkSession);

        function checkSession() {
            const session = localStorage.getItem('moger_session');
            if (session) {
                const data = JSON.parse(session);
                const now = new Date().getTime();
                if (now < data.expiry) {
                    GLOBAL_USER_ROLE = data.role;
                    GLOBAL_CURRENT_CHAR_EMAIL = data.email;
                    
                    if (data.role === 'GM') document.getElementById('btnGMPanelNav').classList.remove('hidden');
                    
                    if (data.charData) {
                        renderFicha(data.charData);
                        toggleScreen('app-screen');
                        iniciarMonitoramento();
                    } else refreshCurrentChar();
                    return;
                } else localStorage.removeItem('moger_session');
            }
        }

        function saveSession(email, role, charData) {
            const now = new Date().getTime();
            localStorage.setItem('moger_session', JSON.stringify({ email: email, role: role, charData: charData, expiry: now + (7200000) }));
        }

        function toggleScreen(screenId) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            document.getElementById('btnText').classList.add('hidden');
            document.getElementById('btnLoader').classList.remove('hidden');
            document.getElementById('msgErro').classList.add('hidden');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "login", email: email, senha: pass })
                });
                const data = await response.json();
                if (data.status === 'SUCESSO') {
                    GLOBAL_USER_ROLE = data.role;
                    GLOBAL_CURRENT_CHAR_EMAIL = data.email;
                    
                    let charData = null;
                    if (data.fichaInicial && (data.fichaInicial.status === 'ENCONTRADO' || data.fichaInicial.dados)) {
                        GLOBAL_CURRENT_CHAR_EMAIL = data.fichaInicial.dados.email_dono || email;
                        charData = data.fichaInicial.dados;
                    }
                    
                    // Salva Sessão ANTES do redirecionamento
                    saveSession(GLOBAL_CURRENT_CHAR_EMAIL, GLOBAL_USER_ROLE, charData);

                    // REDIRECIONAMENTO GM IMEDIATO
                    if (data.role === 'GM') {
                        window.location.href = 'gm_login.html';
                        return; // Para a execução aqui
                    }

                    if (charData) {
                        renderFicha(charData);
                        iniciarMonitoramento();
                    }
                    toggleScreen('app-screen');
                } else throw new Error(data.message || "Erro desconhecido");
            } catch (err) {
                document.getElementById('msgErro').innerText = "Erro: " + err.message;
                document.getElementById('msgErro').classList.remove('hidden');
            } finally {
                document.getElementById('btnText').classList.remove('hidden');
                document.getElementById('btnLoader').classList.add('hidden');
            }
        }

        function logout() { localStorage.removeItem('moger_session'); location.reload(); }

        function iniciarMonitoramento() {
            if (intervaloMonitor) clearInterval(intervaloMonitor);
            intervaloMonitor = setInterval(async () => {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: "carregarFichaGM", targetEmail: GLOBAL_CURRENT_CHAR_EMAIL })
                    });
                    const resJson = await response.json();
                    if (resJson.status === 'ENCONTRADO') {
                        const novaFicha = resJson.dados;
                        if (dadosAtuais && JSON.stringify(novaFicha) !== JSON.stringify(dadosAtuais)) {
                            dadosPendentes = novaFicha;
                            document.getElementById('updateAlert').classList.remove('hidden');
                        }
                    }
                } catch (e) { console.warn("Polling error", e); }
            }, 10000);
        }

        function aplicarAtualizacao() {
            if (!dadosPendentes) return;
            renderFicha(dadosPendentes);
            saveSession(GLOBAL_CURRENT_CHAR_EMAIL, GLOBAL_USER_ROLE, dadosPendentes);
            dadosPendentes = null;
            document.getElementById('updateAlert').classList.add('hidden');
        }

        // --- SISTEMA DE DADOS ---
        function toggleDiceModal() {
            const m = document.getElementById('diceModal');
            m.classList.toggle('hidden'); m.classList.toggle('flex');
            document.getElementById('diceResultMain').innerText = "-";
            document.getElementById('diceResultDetail').innerText = "Clique em um dado";
            document.getElementById('diceIconAnim').classList.remove('fa-spin');
        }
        function rollCustom(e) { e.preventDefault(); parseAndRoll(document.getElementById('customRoll').value.replace('/roll', '').trim()); }
        function rollDice(faces) { parseAndRoll(`1d${faces}`); }
        function parseAndRoll(expr) {
            const main = document.getElementById('diceResultMain');
            const icon = document.getElementById('diceIconAnim');
            main.className = "text-5xl font-black text-white relative z-10 dice-anim";
            icon.classList.add('fa-spin');
            setTimeout(() => {
                const match = expr.match(/^(\d*)d(\d+)([\+\-]\d+)?$/i);
                if (!match) { main.innerText = "?"; icon.classList.remove('fa-spin'); return; }
                const count = parseInt(match[1]) || 1;
                const faces = parseInt(match[2]);
                const mod = parseInt(match[3]) || 0;
                let total = 0, rolls = [], isCrit = false, isFumble = false;
                for(let i=0; i<count; i++) {
                    const r = Math.floor(Math.random() * faces) + 1;
                    rolls.push(r); total += r;
                    if (faces === 20 && i === 0) { if (r === 20) isCrit = true; if (r === 1) isFumble = true; }
                }
                total += mod;
                icon.classList.remove('fa-spin');
                main.innerText = total;
                let details = `[${rolls.join('+')}]` + (mod !== 0 ? (mod > 0 ? ` +${mod}` : ` ${mod}`) : "");
                if (isCrit) { main.className += " dice-result-crit"; details += " CRÍTICO!"; }
                else if (isFumble) { main.className += " dice-result-fumble"; details += " FALHA!"; }
                document.getElementById('diceResultDetail').innerText = details;
            }, 400);
        }

        // --- RENDERIZAÇÃO ---
        async function refreshCurrentChar() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "carregarFichaGM", targetEmail: GLOBAL_CURRENT_CHAR_EMAIL })
                });
                const data = await response.json();
                if (data.status === 'ENCONTRADO') {
                    renderFicha(data.dados);
                    saveSession(GLOBAL_CURRENT_CHAR_EMAIL, GLOBAL_USER_ROLE, data.dados);
                }
            } catch(e) { console.error(e); } 
        }

        function renderFicha(dados) {
            dadosAtuais = dados;
            
            document.getElementById('charNameDisplay').innerText = dados.nome || "Sem Nome";
            document.getElementById('charClassDisplay').innerText = (dados.cla || "") + " - " + (dados.ocupação || "");
            document.getElementById('charLevel').innerText = "Nível " + (dados.nivel || 0);

            updateBar('hp', dados.hp_atual, dados.hp_max);
            updateBar('ether', dados.ether_atual, dados.ether_max);
            updateBar('destino', dados.destino_atual, dados.destino_max);

            const hpAtual = parseInt(dados.hp_atual) || 0;
            const hpMax = parseInt(dados.hp_max) || 1;
            const pctHp = (hpAtual / hpMax) * 100;

            let imgUrl = dados.img_saudavel;

            if (pctHp < 25) {
                imgUrl = dados.img_muito_ferido || dados.img_ferido || dados.img_saudavel;
            } else if (pctHp < 50) {
                imgUrl = dados.img_ferido || dados.img_saudavel;
            }

            if (!imgUrl) imgUrl = "https://via.placeholder.com/300x400?text=Sem+Imagem";
            document.getElementById('charImage').src = imgUrl;

            document.getElementById('attrFisico').innerText = dados.fisico || 0;
            document.getElementById('attrDestreza').innerText = dados.destreza || 0;
            document.getElementById('attrCognicao').innerText = dados.cognicao || 0;
            document.getElementById('attrCarisma').innerText = dados.carisma || 0;
            document.getElementById('attrPrimordio').innerText = dados.primordio || 0;

            document.getElementById('ferrFisico').innerText = "+" + (dados.ferramenta_fisico || 0);
            document.getElementById('ferrDestreza').innerText = "+" + (dados.ferramenta_destreza || 0);
            document.getElementById('ferrCognicao').innerText = "+" + (dados.ferramenta_cognicao || 0);
            document.getElementById('ferrCarisma').innerText = "+" + (dados.ferramenta_carisma || 0);

            setHTML('tab-ataques', dados.html_ataques);
            setHTML('tab-dons', dados.html_dons);
            setHTML('tab-equip', dados.html_equipamentos);
            setHTML('tab-defesa', dados.html_defesa);
        }

        function updateBar(type, atual, max) {
            const val = parseInt(atual) || 0;
            const m = parseInt(max) || 1;
            const pct = Math.min(100, Math.max(0, (val / m) * 100));
            document.getElementById(`${type}Text`).innerText = `${val}/${m}`;
            document.getElementById(`${type}Bar`).style.width = `${pct}%`;
        }
        function setHTML(id, content) {
            const el = document.getElementById(id);
            if (!content || content.trim() === "") el.innerHTML = "<p class='italic opacity-50 text-center py-4'>Nada registrado.</p>";
            else el.innerHTML = content.replace(/\n/g, "<br>");
        }
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => { el.classList.remove('text-indigo-400', 'border-indigo-500'); el.classList.add('text-slate-400', 'border-transparent'); });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            const activeBtn = document.querySelector(`button[data-tab="${tabName}"]`);
            if (activeBtn) { activeBtn.classList.add('text-indigo-400', 'border-indigo-500'); activeBtn.classList.remove('text-slate-400', 'border-transparent'); }
        }
    </script>
</body>
</html>
