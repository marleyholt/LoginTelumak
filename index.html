<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telumak RPG | Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root { --color-bg: #0f172a; --color-card: #1e293b; --color-text: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-bg); color: var(--color-text); overflow-x: hidden; }
        h1, h2, h3, .rpg-font { font-family: 'Cinzel', serif; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Barras */
        .bar-container { background: rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden; height: 20px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); position: relative; }
        .bar-fill { height: 100%; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; font-size: 0.7rem; font-weight: bold; text-shadow: 1px 1px 2px black; }
        /* Efeito de Brilho Interno e Externo nas Barras */
        .hp-fill { 
        background: linear-gradient(90deg, #7f1d1d, #ef4444); 
        box-shadow: 0 0 10px rgba(239, 68, 68, 0.6);
        }
        .ether-fill { 
        background: linear-gradient(90deg, #1e3a8a, #3b82f6); 
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.6);
        }
        .destino-fill { 
        background: linear-gradient(90deg, #a16207, #facc15); 
        box-shadow: 0 0 10px rgba(250, 204, 21, 0.6);
        }
        /* Ajuste no container da barra para ser arredondado (c치psula) */
        .bar-track {
        background-color: #0f172a; /* Slate 900 */
        border: 1px solid #334155; /* Slate 700 */
        border-radius: 9999px; /* Pill shape */
        overflow: hidden;
        height: 12px; /* Barra mais fina e elegante */
        position: relative;
        }
        /* ... (mantenha os anteriores hp, ether, destino) ... */
        .alcance-fill { background: linear-gradient(90deg, #059669, #34d399); }   /* Verde Esmeralda */
        .movimento-fill { background: linear-gradient(90deg, #0891b2, #22d3ee); } /* Ciano */
        .fortitude-fill { background: linear-gradient(90deg, #7c3aed, #a78bfa); } /* Roxo Violeta */
        
        /* Conte칰do Rico */
        .html-content strong { color: #818cf8; } .html-content b { color: #f472b6; }

        /* Dados e FAB */
        .fab-dice { position: fixed; bottom: 20px; right: 20px; z-index: 50; transition: transform 0.2s; animation: float 3s ease-in-out infinite; }
        .fab-dice:hover { transform: scale(1.1); }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        .dice-result-crit { color: #4ade80; text-shadow: 0 0 10px #22c55e; }
        .dice-result-fumble { color: #f87171; text-shadow: 0 0 10px #ef4444; }
        .dice-anim { animation: rollDiceAnim 0.5s ease-out; }
        @keyframes rollDiceAnim { 0% { transform: rotate(0deg) scale(0.5); } 100% { transform: rotate(360deg) scale(1); } }
        
        /* Anima칞칚o de Tremor (Caos antes da ordem) */
@keyframes chaosShake {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    10% { transform: translate(-1px, -2px) rotate(-1deg); }
    20% { transform: translate(-3px, 0px) rotate(1deg); }
    30% { transform: translate(3px, 2px) rotate(0deg); }
    40% { transform: translate(1px, -1px) rotate(1deg); }
    50% { transform: translate(-1px, 2px) rotate(-1deg); }
    60% { transform: translate(-3px, 1px) rotate(0deg); }
    70% { transform: translate(3px, 1px) rotate(-1deg); }
    80% { transform: translate(-1px, -1px) rotate(1deg); }
    90% { transform: translate(1px, 2px) rotate(0deg); }
    100% { transform: translate(1px, -2px) rotate(-1deg); }
}

.rolling-chaos {
    animation: chaosShake 0.1s infinite;
    color: #94a3b8; /* Slate 400 - cor neutra enquanto rola */
}

/* Resultado Final - Efeito de Impacto */
.result-pop {
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes popIn {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}

    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- CONFIG API -->
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxw4VQm5jkVNbkhc-9Q2W8RcdYKHARTrTj0tRb0eKe8ujslyM8NNEwNHhu-wxgPsu9zSw/exec";
    </script>

    <!-- LOGIN -->
    <div id="login-screen" class="flex-grow flex items-center justify-center p-4 relative">
        <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1519074069444-1ba4fff66d16?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80')] bg-cover bg-center opacity-20"></div>
        <div class="bg-slate-900/90 backdrop-blur-md p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700 relative z-10 fade-in flex flex-col items-center">
            
            <!-- LOGO: Substitua pelo link direto se necess치rio -->
            <img src="LINK_DA_SUA_LOGO_AQUI.png" 
                 onerror="this.style.display='none'; document.getElementById('logo-fallback').classList.remove('hidden');"
                 alt="TELUMAK" class="h-24 mb-4 object-contain filter drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]">
            
            <i id="logo-fallback" class="fas fa-dragon text-6xl text-yellow-600 mb-4 hidden animate-pulse"></i>

            <h1 class="text-3xl text-yellow-600 font-bold mb-1 rpg-font tracking-widest">TELUMAK RPG</h1>
            <p class="text-slate-400 text-sm mb-8">Acesso ao Grim칩rio Digital</p>

            <form id="loginForm" onsubmit="handleLogin(event)" class="w-full">
                <div class="mb-4">
                    <label class="block text-slate-300 text-sm font-bold mb-2 ml-1">Email</label>
                    <input type="email" id="email" required class="w-full bg-slate-800 border border-slate-600 rounded-lg py-2 px-4 text-white focus:outline-none focus:border-yellow-600 transition shadow-inner">
                </div>
                <div class="mb-6">
                    <label class="block text-slate-300 text-sm font-bold mb-2 ml-1">Senha</label>
                    <input type="password" id="password" required class="w-full bg-slate-800 border border-slate-600 rounded-lg py-2 px-4 text-white focus:outline-none focus:border-yellow-600 transition shadow-inner">
                </div>
                <button type="submit" id="btnLogin" class="w-full bg-yellow-700 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg transition transform hover:scale-[1.02] shadow-lg flex justify-center items-center">
                    <span id="btnText">Entrar</span>
                    <i id="btnLoader" class="fas fa-circle-notch fa-spin ml-2 hidden"></i>
                </button>
            </form>
            <p id="msgErro" class="text-red-400 text-center text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="app-screen" class="hidden relative min-h-screen pb-20">
        <!-- Navbar -->
        <nav class="bg-slate-900 border-b border-slate-800 p-3 sticky top-0 z-40 shadow-lg flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="h-10 w-auto overflow-hidden flex items-center">
                    <span class="text-xl font-bold text-yellow-600 rpg-font tracking-widest border border-yellow-600/30 px-2 rounded bg-black/40">TELUMAK RPG</span>
                </div>
                <div class="h-8 w-px bg-slate-700 mx-1"></div>
                <div>
                    <h2 id="charNameDisplay" class="text-lg font-bold text-white leading-tight">...</h2>
                    <p id="charClassDisplay" class="text-[10px] text-yellow-500 uppercase tracking-wider">...</p>
                </div>
            </div>
            <div class="flex gap-4">
                <button id="btnGMPanelNav" onclick="window.location.href='gm_login.html'" class="hidden text-indigo-400 hover:text-indigo-300 font-bold border border-indigo-500/50 px-3 py-1 rounded transition flex items-center gap-2">
                    <i class="fas fa-tools"></i> <span class="hidden md:inline">GM</span>
                </button>
                <button onclick="irParaGrid()" class="text-emerald-400 hover:text-emerald-300 font-bold border border-emerald-500/50 px-3 py-1 rounded transition flex items-center gap-2" title="Mesa de Batalha">
    		        <i class="fas fa-chess-board"></i> <span class="hidden md:inline">Entrar na Mesa</span>
		        </button>
                <button onclick="logout()" class="text-slate-400 hover:text-red-400 transition" title="Sair"><i class="fas fa-sign-out-alt text-xl"></i></button>
            </div>
        </nav>

        <main class="container mx-auto p-4 max-w-4xl space-y-6">
            
            <div id="updateAlert" onclick="aplicarAtualizacao()" class="hidden cursor-pointer bg-indigo-600 hover:bg-indigo-500 text-white p-3 rounded-lg shadow-lg animate-bounce text-center font-bold mb-4 border border-indigo-400">
                <i class="fas fa-sync-alt fa-spin mr-2"></i> ATUALIZA칂츾O DISPON칈VEL!
            </div>

            <!-- Status TESTE-->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    
    <div class="bg-black p-4 rounded-xl border border-slate-800 shadow-lg relative overflow-hidden group hover:border-red-900/50 transition duration-500">
        <div class="flex justify-between items-end mb-2">
            <span class="text-red-500 text-[13px] uppercase font-bold tracking-[0.2em] flex items-center gap-2">
                <i class="fas fa-heart animate-pulse"></i> Sa칰de 
            </span>
            <span id="hpText" class="text-white font-['Cinzel'] font-bold text-xl drop-shadow-[0_0_5px_rgba(239,68,68,0.5)]">0/0</span>
        </div>
        
        <div class="bar-track">
            <div id="hpBar" class="h-full hp-fill transition-all duration-700 ease-out" style="width: 0%"></div>
        </div>
    </div>

    <div class="bg-black p-4 rounded-xl border border-slate-800 shadow-lg relative overflow-hidden group hover:border-blue-900/50 transition duration-500">
        <div class="flex justify-between items-end mb-2">
            <span class="text-blue-500 text-[13px] uppercase font-bold tracking-[0.2em] flex items-center gap-2">
                <i class="fas fa-bolt"></i> Energia
            </span>
            <span id="etherText" class="text-white font-['Cinzel'] font-bold text-xl drop-shadow-[0_0_5px_rgba(59,130,246,0.5)]">0/0</span>
        </div>
        
        <div class="bar-track">
            <div id="etherBar" class="h-full ether-fill transition-all duration-700 ease-out" style="width: 0%"></div>
        </div>
    </div>

    <div class="bg-black p-4 rounded-xl border border-slate-800 shadow-lg relative overflow-hidden group hover:border-yellow-900/50 transition duration-500">
        <div class="flex justify-between items-end mb-2">
            <span class="text-yellow-500 text-[13px] uppercase font-bold tracking-[0.2em] flex items-center gap-2">
                <i class="fas fa-star spin-slow"></i> Poder
            </span>
            <span id="destinoText" class="text-white font-['Cinzel'] font-bold text-xl drop-shadow-[0_0_5px_rgba(250,204,21,0.5)]">0/0</span>
        </div>
        
        <div class="bar-track">
            <div id="destinoBar" class="h-full destino-fill transition-all duration-700 ease-out" style="width: 0%"></div>
        </div>
    </div>

</div>
            <!--MARCADORES TESTE-->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6"> 
    
    <div class="bg-black p-3 rounded-xl border border-slate-800 shadow-lg flex flex-col items-center group hover:border-emerald-500 hover:shadow-[0_0_15px_rgba(16,185,129,0.3)] transition duration-500">
        <div class="flex items-center justify-between w-full px-2 mb-3 border-b border-slate-800/50 pb-2">
            <div class="flex items-center gap-2">
                <i class="fas fa-bullseye text-emerald-500 text-sm drop-shadow-[0_0_5px_rgba(16,185,129,0.8)]"></i>
                <span class="text-slate-400 text-xs font-bold tracking-[0.2em]">ALCANCE</span>
            </div>
            <span id="alcanceNivel" class="text-white font-['Cinzel'] font-bold text-lg bg-slate-900 border border-slate-800 px-3 rounded shadow-inner">0</span>
        </div>
        
        <div class="w-full bg-slate-900/40 border border-emerald-500/20 rounded-lg py-4 text-center relative overflow-hidden group-hover:bg-emerald-900/10 transition duration-500">
            <span id="alcanceDetalhe" class="text-2xl font-black text-emerald-400 font-mono block leading-none drop-shadow-[0_0_8px_rgba(52,211,153,0.6)]">
                0m
            </span>
        </div>
    </div>

    <div class="bg-black p-3 rounded-xl border border-slate-800 shadow-lg flex flex-col items-center group hover:border-cyan-500 hover:shadow-[0_0_15px_rgba(6,182,212,0.3)] transition duration-500">
        <div class="flex items-center justify-between w-full px-2 mb-3 border-b border-slate-800/50 pb-2">
            <div class="flex items-center gap-2">
                <i class="fas fa-running text-cyan-500 text-sm drop-shadow-[0_0_5px_rgba(6,182,212,0.8)]"></i>
                <span class="text-slate-400 text-xs font-bold tracking-[0.2em]">MOVIMENTO</span>
            </div>
            <span id="movimentoNivel" class="text-white font-['Cinzel'] font-bold text-lg bg-slate-900 border border-slate-800 px-3 rounded shadow-inner">0</span>
        </div>
        
        <div class="w-full bg-slate-900/40 border border-cyan-500/20 rounded-lg py-4 text-center relative overflow-hidden group-hover:bg-cyan-900/10 transition duration-500">
            <span id="movimentoDetalhe" class="text-xl font-black text-cyan-400 font-mono block leading-none drop-shadow-[0_0_8px_rgba(34,211,238,0.6)]">
                0m A칞칚o
            </span>
        </div>
    </div>

    <div class="bg-black p-3 rounded-xl border border-slate-800 shadow-lg flex flex-col items-center group hover:border-violet-500 hover:shadow-[0_0_15px_rgba(139,92,246,0.3)] transition duration-500">
        <div class="flex items-center justify-between w-full px-2 mb-3 border-b border-slate-800/50 pb-2">
            <div class="flex items-center gap-2">
                <i class="fas fa-shield-alt text-violet-500 text-sm drop-shadow-[0_0_5px_rgba(139,92,246,0.8)]"></i>
                <span class="text-slate-400 text-xs font-bold tracking-[0.2em]">FORTITUDE</span>
            </div>
            <span id="fortitudeNivel" class="text-white font-['Cinzel'] font-bold text-lg bg-slate-900 border border-slate-800 px-3 rounded shadow-inner">0</span>
        </div>
        
        <div class="w-full bg-slate-900/40 border border-violet-500/20 rounded-lg py-4 text-center relative overflow-hidden group-hover:bg-violet-900/10 transition duration-500">
            <span id="fortitudeDetalhe" class="text-2xl font-black text-violet-400 font-mono block leading-none drop-shadow-[0_0_8px_rgba(167,139,250,0.6)]">
                0 Kg
            </span>
        </div>
    </div>

</div>

            <!-- Imagem e Atributos -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Imagem -->
                <div class="md:col-span-1">
                    <div class="relative aspect-[10/17] rounded-xl overflow-hidden shadow-2xl border-2 border-slate-700 group bg-black">
                        <img id="charImage" src="" 
                             onerror="this.src='https://via.placeholder.com/300x400?text=Link+Quebrado'; this.onerror=null;"
                             alt="Personagem" class="w-full h-full object-cover transition duration-500 group-hover:scale-105">
                        
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 p-4">
                            <span id="charLevel" class="bg-yellow-700 text-white text-xs px-2 py-1 rounded font-bold border border-yellow-500">N칤vel ?</span>
                        </div>
                    </div>
                </div>
                
                <!-- Atributos teste-->
                 <div class="md:col-span-2 flex flex-col gap-4">
    
    <div class="grid grid-cols-2 gap-3">
        
        <div class="bg-black p-4 rounded-xl border border-slate-700 shadow-xl flex flex-col items-center justify-center relative group hover:border-slate-500 transition duration-500">
            <div class="absolute inset-0 bg-slate-900/0 group-hover:bg-slate-900/40 transition duration-500 rounded-xl"></div>
            
            <span class="text-white text-[10px] uppercase tracking-[0.2em] font-bold mb-2 z-10 border-b border-slate-800 w-full text-center pb-1">F칤sico</span>
            <span id="attrFisico" class="text-4xl text-white font-['Cinzel'] font-bold z-10 drop-shadow-[0_0_8px_rgba(255,255,255,0.2)]">0</span>
        </div>

        <div class="bg-black p-4 rounded-xl border border-slate-700 shadow-xl flex flex-col items-center justify-center relative group hover:border-slate-500 transition duration-500">
            <div class="absolute inset-0 bg-slate-900/0 group-hover:bg-slate-900/40 transition duration-500 rounded-xl"></div>
            
            <span class="text-white text-[10px] uppercase tracking-[0.2em] font-bold mb-2 z-10 border-b border-slate-800 w-full text-center pb-1">Destreza</span>
            <span id="attrDestreza" class="text-4xl text-white font-['Cinzel'] font-bold z-10 drop-shadow-[0_0_8px_rgba(255,255,255,0.2)]">0</span>
        </div>

        <div class="bg-black p-4 rounded-xl border border-slate-700 shadow-xl flex flex-col items-center justify-center relative group hover:border-slate-500 transition duration-500">
            <div class="absolute inset-0 bg-slate-900/0 group-hover:bg-slate-900/40 transition duration-500 rounded-xl"></div>
            
            <span class="text-white text-[10px] uppercase tracking-[0.2em] font-bold mb-2 z-10 border-b border-slate-800 w-full text-center pb-1">Cogni칞칚o</span>
            <span id="attrCognicao" class="text-4xl text-white font-['Cinzel'] font-bold z-10 drop-shadow-[0_0_8px_rgba(255,255,255,0.2)]">0</span>
        </div>

        <div class="bg-black p-4 rounded-xl border border-slate-700 shadow-xl flex flex-col items-center justify-center relative group hover:border-slate-500 transition duration-500">
            <div class="absolute inset-0 bg-slate-900/0 group-hover:bg-slate-900/40 transition duration-500 rounded-xl"></div>
            
            <span class="text-white text-[10px] uppercase tracking-[0.2em] font-bold mb-2 z-10 border-b border-slate-800 w-full text-center pb-1">Carisma</span>
            <span id="attrCarisma" class="text-4xl text-white font-['Cinzel'] font-bold z-10 drop-shadow-[0_0_8px_rgba(255,255,255,0.2)]">0</span>
        </div>

        <div class="col-span-2 bg-black p-3 rounded-xl border border-slate-700 shadow-2xl flex justify-between items-center px-6 relative overflow-hidden group">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20"></div>
            
            <span class="text-white text-xs uppercase font-bold tracking-[0.3em] z-10 flex items-center gap-2">
                <i class="fas fa-moon text-slate-400"></i> Prim칩rdio
            </span>
            <span id="attrPrimordio" class="text-4xl font-['Cinzel'] font-bold text-white z-10 drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">0</span>
        </div>
    </div>
                    <!-- Ferramentas de Combate Teste-->
    <div class="bg-black/50 rounded-lg border border-slate-700 p-4">
        <h4 class="text-[11px] text-slate-400 uppercase font-bold mb-3 border-b border-slate-800 pb-2 flex items-center tracking-widest">
            <i class="fas fa-tools mr-2"></i> Ferramentas de Combate
        </h4>
        <div class="grid grid-cols-4 gap-3 text-center">
            <div class="bg-black rounded border border-slate-600 p-2">
                <span class="block text-[10px] text-slate-500 uppercase tracking-wider mb-1">RESISTIR | ESMAGAR</span>
                <span id="ferrFisico" class="text-sm font-mono text-white font-bold">+0</span>
            </div>
            <div class="bg-black rounded border border-slate-600 p-2">
                <span class="block text-[10px] text-slate-500 uppercase tracking-wider mb-1">EVADIR  |  ABDICAR</span>
                <span id="ferrDestreza" class="text-sm font-mono text-white font-bold">+0</span>
            </div>
            <div class="bg-black rounded border border-slate-600 p-2">
                <span class="block text-[10px] text-slate-500 uppercase tracking-wider mb-1">PREVER CONCENTRAR</span>
                <span id="ferrCognicao" class="text-sm font-mono text-white font-bold">+0</span>
            </div>
            <div class="bg-black rounded border border-slate-600 p-2">
                <span class="block text-[10px] text-slate-500 uppercase tracking-wider mb-1">RECUPERAR INTIMIDAR</span>
                <span id="ferrCarisma" class="text-sm font-mono text-white font-bold">+0</span>
            </div>
        </div>
    </div>

</div>
                
            </div>

            <!-- Abas -->
            <div class="bg-slate-800 rounded-xl shadow-lg border border-slate-700 overflow-hidden">
                <div class="flex overflow-x-auto bg-slate-900/50 border-b border-slate-700">
                    <button onclick="switchTab('ataques')" class="tab-btn active px-6 py-4 text-sm font-bold text-indigo-400 border-b-2 border-indigo-500 whitespace-nowrap" data-tab="ataques">Ataques</button>
                    <button onclick="switchTab('dons')" class="tab-btn px-6 py-4 text-sm font-bold text-slate-400 hover:text-white border-b-2 border-transparent whitespace-nowrap" data-tab="dons">Dons</button>
                    <button onclick="switchTab('equip')" class="tab-btn px-6 py-4 text-sm font-bold text-slate-400 hover:text-white border-b-2 border-transparent whitespace-nowrap" data-tab="equip">Equipamento</button>
                    <button onclick="switchTab('defesa')" class="tab-btn px-6 py-4 text-sm font-bold text-slate-400 hover:text-white border-b-2 border-transparent whitespace-nowrap" data-tab="defesa">Defesa</button>
                </div>
                <div class="p-6 min-h-[200px]">
                    <div id="tab-ataques" class="tab-content fade-in html-content text-slate-300 text-sm leading-relaxed"></div>
                    <div id="tab-dons" class="tab-content hidden fade-in html-content text-slate-300 text-sm leading-relaxed"></div>
                    <div id="tab-equip" class="tab-content hidden fade-in html-content text-slate-300 text-sm leading-relaxed"></div>
                    <div id="tab-defesa" class="tab-content hidden fade-in html-content text-slate-300 text-sm leading-relaxed"></div>
                </div>
            </div>
            
            <div class="text-center text-slate-600 text-xs pb-8">Sistema TELUMAK</div>
        </main>
        
        <!-- FAB DICE -->
        <button onclick="toggleDiceModal()" class="fab-dice bg-yellow-700 hover:bg-yellow-600 text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center text-3xl border-4 border-slate-800">
            <i class="fas fa-dice-d20"></i>
        </button>

        <!-- BOT칏ES DADOS-->
         <div id="diceModal" class="fixed inset-0 bg-black/95 backdrop-blur-sm hidden items-center justify-center z-50 fade-in">
    <div class="bg-black w-full max-w-md rounded-2xl shadow-2xl border border-slate-800 p-6 relative">
        
        <button onclick="toggleDiceModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white transition">
            <i class="fas fa-times fa-lg"></i>
        </button>

        <h3 class="text-slate-400 font-bold text-xs tracking-[0.3em] uppercase text-center mb-6">
            <i class="fas fa-dice-d20 mr-2"></i>Or치culo do Destino
        </h3>

        <div class="bg-slate-900/50 p-6 rounded-2xl mb-6 text-center border border-slate-800 flex flex-col justify-center items-center min-h-[140px] relative overflow-hidden">
            <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-800/30 via-transparent to-transparent"></div>
            
            <div id="diceResultMain" class="text-7xl font-['Cinzel'] font-bold text-white relative z-10 transition-all">-</div>
            
            <div id="diceResultDetail" class="text-[10px] text-slate-400 mt-3 font-mono tracking-widest uppercase break-words w-full px-2 relative z-10 min-h-[1.5rem]">
                Aguardando Rolagem
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
            <button onclick="rollSystem(1, 0)" class="bg-slate-800 hover:bg-slate-700 text-white font-['Cinzel'] font-bold py-3 rounded-xl border border-slate-700 hover:border-yellow-600 transition-all group">
                <span class="text-yellow-500 block text-xs tracking-widest mb-1">DESTINO</span>
                1d10
            </button>
            <button onclick="rollSystem(4, 0)" class="bg-slate-800 hover:bg-slate-700 text-white font-['Cinzel'] font-bold py-3 rounded-xl border border-slate-700 hover:border-yellow-600 transition-all group">
                <span class="text-yellow-500 block text-xs tracking-widest mb-1">ATRIBUTOS</span>
                4d10
            </button>
        </div>

        <div class="bg-slate-900/30 rounded-xl p-3 border border-slate-800/50">
            <label class="block text-[9px] text-slate-500 uppercase tracking-widest mb-2 text-center">Rolagem Customizada</label>
            <form onsubmit="handleCustomRoll(event)" class="flex gap-2">
                <input type="number" id="inputQtd" placeholder="Qtd (Ex: 14)" class="w-1/3 bg-black border border-slate-700 rounded px-3 py-2 text-white text-center focus:border-yellow-500 outline-none font-mono">
                
                <span class="text-slate-500 self-center">d10 +</span>
                
                <input type="number" id="inputMod" placeholder="B칪nus (Ex: 85)" class="w-1/3 bg-black border border-slate-700 rounded px-3 py-2 text-white text-center focus:border-yellow-500 outline-none font-mono">
                
                <button type="submit" class="bg-yellow-700 hover:bg-yellow-600 text-white px-4 rounded border border-yellow-600 font-bold transition">
                    <i class="fas fa-play"></i>
                </button>
            </form>
            <p class="text-[9px] text-slate-600 mt-2 text-center italic">*Cr칤ticos (10) explodem uma vez.</p>
        </div>
        <div class="mt-4 pt-4 border-t border-slate-800">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">
                    <i class="fas fa-scroll mr-1"></i> Hist칩rico
                </h4>
                
                <button id="btnLimparHist" onclick="acaoLimparHistorico()" class="hidden text-[9px] text-red-500 hover:text-red-400 font-bold border border-red-900/30 px-2 py-1 rounded bg-red-900/10 uppercase transition">
                    <i class="fas fa-trash"></i> Limpar (GM)
                </button>
            </div>
            
            <div id="listaHistorico" class="h-32 overflow-y-auto bg-slate-900/20 rounded border border-slate-800 p-2 space-y-2 scrollbar-hide">
                <div class="text-center text-slate-600 text-[10px] italic py-4">Carregando...</div>
            </div>
            
            <button onclick="carregarHistorico()" class="w-full text-center text-[9px] text-slate-600 hover:text-slate-400 mt-1 cursor-pointer">
                Toque para atualizar
            </button>
        </div>
    </div>
</div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        let GLOBAL_USER_ROLE = "PLAYER";
        let GLOBAL_CURRENT_CHAR_EMAIL = "";
        let dadosAtuais = null;
        let dadosPendentes = null;
        let intervaloMonitor = null;

        document.addEventListener('DOMContentLoaded', checkSession);

        function checkSession() {
            const session = localStorage.getItem('moger_session');
            if (session) {
                const data = JSON.parse(session);
                const now = new Date().getTime();
                if (now < data.expiry) {
                    GLOBAL_USER_ROLE = data.role;
                    GLOBAL_CURRENT_CHAR_EMAIL = data.email;
                    
                    if (data.role === 'GM') document.getElementById('btnGMPanelNav').classList.remove('hidden');
                    
                    if (data.charData) {
                        renderFicha(data.charData);
                        toggleScreen('app-screen');
                        iniciarMonitoramento();
                    } else refreshCurrentChar();
                    return;
                } else localStorage.removeItem('moger_session');
            }
        }

        function saveSession(email, role, charData) {
            const now = new Date().getTime();
            localStorage.setItem('moger_session', JSON.stringify({ email: email, role: role, charData: charData, expiry: now + (7200000) }));
        }

        function toggleScreen(screenId) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            document.getElementById('btnText').classList.add('hidden');
            document.getElementById('btnLoader').classList.remove('hidden');
            document.getElementById('msgErro').classList.add('hidden');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "login", email: email, senha: pass })
                });
                const data = await response.json();
                if (data.status === 'SUCESSO') {
                    GLOBAL_USER_ROLE = data.role;
                    GLOBAL_CURRENT_CHAR_EMAIL = data.email;
                    
                    let charData = null;
                    if (data.fichaInicial && (data.fichaInicial.status === 'ENCONTRADO' || data.fichaInicial.dados)) {
                        GLOBAL_CURRENT_CHAR_EMAIL = data.fichaInicial.dados.email_dono || email;
                        charData = data.fichaInicial.dados;
                    }
                    
                    // Salva Sess칚o ANTES do redirecionamento
                    saveSession(GLOBAL_CURRENT_CHAR_EMAIL, GLOBAL_USER_ROLE, charData);

                    // REDIRECIONAMENTO GM IMEDIATO
                    if (data.role === 'GM') {
                        window.location.href = 'gm_login.html';
                        return; // Para a execu칞칚o aqui
                    }

                    if (charData) {
                        renderFicha(charData);
                        iniciarMonitoramento();
                    }
                    toggleScreen('app-screen');
                } else throw new Error(data.message || "Erro desconhecido");
           } catch (err) {
                console.error("Erro detalhado:", err); // Adicione isso para debugar
                document.getElementById('msgErro').innerText = "Erro: " + err.message;
                document.getElementById('msgErro').classList.remove('hidden');
            } finally {
                document.getElementById('btnText').classList.remove('hidden');
                document.getElementById('btnLoader').classList.add('hidden');
            }
        }

        function logout() { localStorage.removeItem('moger_session'); location.reload(); }

        function iniciarMonitoramento() {
            if (intervaloMonitor) clearInterval(intervaloMonitor);
            intervaloMonitor = setInterval(async () => {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: "carregarFichaGM", targetEmail: GLOBAL_CURRENT_CHAR_EMAIL })
                    });
                    const resJson = await response.json();
                    if (resJson.status === 'ENCONTRADO') {
                        const novaFicha = resJson.dados;
                        if (dadosAtuais && JSON.stringify(novaFicha) !== JSON.stringify(dadosAtuais)) {
                            dadosPendentes = novaFicha;
                            document.getElementById('updateAlert').classList.remove('hidden');
                        }
                    }
                } catch (e) { console.warn("Polling error", e); }
            }, 10000);
        }

        function aplicarAtualizacao() {
            if (!dadosPendentes) return;
            renderFicha(dadosPendentes);
            saveSession(GLOBAL_CURRENT_CHAR_EMAIL, GLOBAL_USER_ROLE, dadosPendentes);
            dadosPendentes = null;
            document.getElementById('updateAlert').classList.add('hidden');
        }

// --- SISTEMA DE DADOS (V3 - OR츼CULO COM EXPLOS츾O) ---

function toggleDiceModal() {
    const m = document.getElementById('diceModal');
    m.classList.toggle('hidden'); 
    m.classList.toggle('flex');
    
    if(!m.classList.contains('hidden')){
        resetDisplay();
        // Verifica GM e carrega hist칩rico
        if (GLOBAL_USER_ROLE === 'GM') document.getElementById('btnLimparHist').classList.remove('hidden');
        carregarHistorico(); 
    }
}

function resetDisplay() {
    const main = document.getElementById('diceResultMain');
    main.className = "text-7xl font-['Cinzel'] font-bold text-slate-600 relative z-10";
    main.innerText = "-";
    document.getElementById('diceResultDetail').innerText = "Aguardando Rolagem";
}

// Handler para o formul치rio customizado
function handleCustomRoll(e) {
    e.preventDefault();
    const qtd = parseInt(document.getElementById('inputQtd').value) || 0;
    const mod = parseInt(document.getElementById('inputMod').value) || 0;
    
    if (qtd > 0) {
        rollSystem(qtd, mod);
    } else {
        alert("Digite pelo menos 1 dado.");
    }
}

// Fun칞칚o Principal do Sistema
function rollSystem(qtdDados, modificador) {
    const main = document.getElementById('diceResultMain');
    const detail = document.getElementById('diceResultDetail');
    
    // 1. Anima칞칚o de "Caos" (Shuffle)
    main.className = "text-7xl font-['Cinzel'] font-bold rolling-chaos relative z-10";
    detail.innerText = `ROLANDO ${qtdDados}d10 + ${modificador}...`;
    detail.className = "text-xs text-slate-500 mt-3 font-mono tracking-widest uppercase relative z-10 animate-pulse";

    let intervals = 0;
    const anim = setInterval(() => {
        // Mostra n칰meros aleat칩rios enquanto "calcula"
        main.innerText = Math.floor(Math.random() * (qtdDados * 10)) + modificador;
        intervals++;
        
        if (intervals >= 12) { // Dura칞칚o da anima칞칚o
            clearInterval(anim);
            calcularResultadoReal(qtdDados, modificador);
        }
    }, 60);
}

function calcularResultadoReal(qtd, mod) {
    let total = 0;
    let rolagens = [];
    let criticos = 0;
    let falhas = 0;

    // L칩gica da Explos칚o (1 Cr칤tico por dado rolado)
    for (let i = 0; i < qtd; i++) {
        let dado = Math.floor(Math.random() * 10) + 1;
        
        // Estrutura para exibir: { base: 10, extra: 4 } ou { base: 5, extra: 0 }
        let infoDado = { base: dado, extra: 0 };

        total += dado;

        if (dado === 10) {
            criticos++;
            // Explode! Rola mais um d10
            let extra = Math.floor(Math.random() * 10) + 1;
            total += extra;
            infoDado.extra = extra;
            
            // Se o extra for 10 ou 1, conta estat칤stica (mas n칚o explode de novo)
            if (extra === 10) criticos++; // Apenas para estat칤stica visual
            if (extra === 1) falhas++;    // Apenas para estat칤stica visual
        } else if (dado === 1) {
            falhas++;
        }

        rolagens.push(infoDado);
    }

    // Soma o modificador final
    total += mod;

    exibirResultado(total, rolagens, mod, criticos);
}

function exibirResultado(total, rolagens, mod, numCriticos) {
    const main = document.getElementById('diceResultMain');
    const detail = document.getElementById('diceResultDetail');

    main.innerText = total;
    main.className = "text-7xl font-['Cinzel'] font-bold relative z-10 result-pop";

    // Define cor baseada na sorte (apenas est칠tico)
    if (numCriticos > 0) {
        main.classList.add("text-emerald-400", "drop-shadow-[0_0_15px_rgba(52,211,153,0.8)]");
    } else {
        main.classList.add("text-white", "drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]");
    }

    // Monta o texto de detalhe: [10+2, 5, 8] + 40
    let strDetalhe = "[ ";
    strDetalhe += rolagens.map(r => {
        if (r.extra > 0) {
            // Mostra o dado explodido: (10+X)
            return `<span class="text-emerald-400 font-bold border-b border-emerald-500">${r.base}+${r.extra}</span>`;
        } else if (r.base === 1) {
            return `<span class="text-red-500">${r.base}</span>`;
        } else {
            return `<span class="text-slate-300">${r.base}</span>`;
        }
    }).join(", ");
    strDetalhe += " ]";

    if (mod !== 0) {
        strDetalhe += ` + <span class="text-yellow-500">${mod}</span>`;
    }

    // Injeta HTML no detalhe para suportar cores
    detail.innerHTML = strDetalhe;
    detail.className = "text-[10px] text-slate-400 mt-3 font-mono leading-relaxed break-words w-full px-4 relative z-10";
    let textoLog = `${rolagens.length}d10${mod >= 0 ? '+'+mod : mod} >> ${total}`;
    if (numCriticos > 0) textoLog += " 游댠"; // 칈cone de fogo se tiver cr칤tico
    
    // Envia para o hist칩rico
    enviarLogRolagem(textoLog);
} 

        // --- RENDERIZA칂츾O ---
        async function refreshCurrentChar() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "carregarFichaGM", targetEmail: GLOBAL_CURRENT_CHAR_EMAIL })
                });
                const data = await response.json();
                if (data.status === 'ENCONTRADO') {
                    renderFicha(data.dados);
                    saveSession(GLOBAL_CURRENT_CHAR_EMAIL, GLOBAL_USER_ROLE, data.dados);
                }
            } catch(e) { console.error(e); } 
        }

        function renderFicha(dados) {
            dadosAtuais = dados;
            
            document.getElementById('charNameDisplay').innerText = dados.nome || "Sem Nome";
            document.getElementById('charClassDisplay').innerText = (dados.cla || "") + " - " + (dados.ocupacao || "");
            document.getElementById('charLevel').innerText = "N칤vel " + (dados.nivel || 0);

            updateBar('hp', dados.hp_atual, dados.hp_max);
            updateBar('ether', dados.ether_atual, dados.ether_max);
            updateBar('destino', dados.destino_atual, dados.destino_max);
            
            // Alcance
            document.getElementById('alcanceNivel').innerText = dados.alcance_atual || 0;
            // Ex: "10m"
            document.getElementById('alcanceDetalhe').innerText = (dados.alcance_max || 0) + " Metros";

            // Movimento
            document.getElementById('movimentoNivel').innerText = dados.movimento_atual || 0;
            // Ex: "15m A칞칚o" (mais curto para caber na fonte grande)
            document.getElementById('movimentoDetalhe').innerText = (dados.movimento_max || 0) + " Metros por A칞칚o"; 

            // Fortitude
            document.getElementById('fortitudeNivel').innerText = dados.fortitude_atual || 0;
            // Ex: "150 Kg"
           document.getElementById('fortitudeDetalhe').innerText = (dados.fortitude_max || 0) + " Kg";

    // ----------------------------------------------------

            const hpAtual = parseInt(dados.hp_atual) || 0;
            const hpMax = parseInt(dados.hp_max) || 1;
            const pctHp = (hpAtual / hpMax) * 100;

            let imgUrl = dados.img_saudavel;

            if (pctHp < 25) {
                imgUrl = dados.img_muito_ferido || dados.img_ferido || dados.img_saudavel;
            } else if (pctHp < 50) {
                imgUrl = dados.img_ferido || dados.img_saudavel;
            }

            if (!imgUrl) imgUrl = "https://via.placeholder.com/300x400?text=Sem+Imagem";
            document.getElementById('charImage').src = imgUrl;

            document.getElementById('attrFisico').innerText = dados.fisico || 0;
            document.getElementById('attrDestreza').innerText = dados.destreza || 0;
            document.getElementById('attrCognicao').innerText = dados.cognicao || 0;
            document.getElementById('attrCarisma').innerText = dados.carisma || 0;
            document.getElementById('attrPrimordio').innerText = dados.primordio || 0;

            document.getElementById('ferrFisico').innerText = "+" + (dados.ferramenta_fisico || 0);
            document.getElementById('ferrDestreza').innerText = "+" + (dados.ferramenta_destreza || 0);
            document.getElementById('ferrCognicao').innerText = "+" + (dados.ferramenta_cognicao || 0);
            document.getElementById('ferrCarisma').innerText = "+" + (dados.ferramenta_carisma || 0);

            setHTML('tab-ataques', dados.html_ataques);
            setHTML('tab-dons', dados.html_dons);
            setHTML('tab-equip', dados.html_equipamentos);
            setHTML('tab-defesa', dados.html_defesa);
        }

        function updateBar(type, atual, max) {
            const val = parseInt(atual) || 0;
            const m = parseInt(max) || 1;
            const pct = Math.min(100, Math.max(0, (val / m) * 100));
            document.getElementById(`${type}Text`).innerText = `${val}/${m}`;
            document.getElementById(`${type}Bar`).style.width = `${pct}%`;
        }
        function setHTML(id, content) {
            const el = document.getElementById(id);
            if (!content || content.trim() === "") el.innerHTML = "<p class='italic opacity-50 text-center py-4'>Nada registrado.</p>";
            else el.innerHTML = content.replace(/\n/g, "<br>");
        }
        function switchTab(tabName) {
            // 1. Esconde todos os conte칰dos
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            
            // 2. Reseta cores dos bot칫es
            document.querySelectorAll('.tab-btn').forEach(el => { 
                el.classList.remove('text-indigo-400', 'border-indigo-500'); 
                el.classList.add('text-slate-400', 'border-transparent'); 
            });
            
            // 3. Mostra o conte칰do escolhido
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            // 4. Acende o bot칚o escolhido
            const activeBtn = document.querySelector(`button[data-tab="${tabName}"]`);
            if (activeBtn) { 
                activeBtn.classList.add('text-indigo-400', 'border-indigo-500'); 
                activeBtn.classList.remove('text-slate-400', 'border-transparent'); 
            }
        } 
        // -----------------------------------------------------------------
        // <--- AQUI FECHA A FUN칂츾O switchTab (ESSA CHAVE } 칄 O SEGREDO!)
        // -----------------------------------------------------------------


        // --- FUN칂칏ES DE HIST칍RICO (AGORA EST츾O LIVRES PARA FUNCIONAR) ---

        async function enviarLogRolagem(textoResultado) {
            // Tenta pegar o nome da tela, se falhar, usa o email ou "Desconhecido"
            const elNome = document.getElementById('charNameDisplay');
            const nome = elNome ? elNome.innerText : (GLOBAL_CURRENT_CHAR_EMAIL || "Desconhecido");
            
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "registrarRolagem", usuario: nome, resumo: textoResultado })
                });
                carregarHistorico();
            } catch (e) { console.error("Erro ao salvar log", e); }
        }

        async function carregarHistorico() {
            const div = document.getElementById('listaHistorico');
            // Mostra carregando
            div.innerHTML = '<div class="text-center text-slate-600 text-[10px] italic py-4"><i class="fas fa-circle-notch fa-spin"></i> Buscando...</div>';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "lerHistorico" })
                });
                const data = await response.json();
                
                div.innerHTML = ""; 
                if (data.status === "SUCESSO" && data.logs && data.logs.length > 0) {
                    data.logs.forEach(log => {
                        const dataObj = new Date(log.data);
                        const hora = !isNaN(dataObj) ? dataObj.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) : "--:--";
                        
                        div.innerHTML += `
                            <div class="border-b border-slate-800/50 pb-1 mb-1 last:border-0">
                                <div class="flex justify-between text-[9px] text-slate-500">
                                    <span class="font-bold text-slate-400">${log.quem}</span>
                                    <span>${hora}</span>
                                </div>
                                <div class="text-emerald-400 text-xs font-mono font-bold leading-tight mt-1">${log.resultado}</div>
                            </div>`;
                    });
                } else {
                    div.innerHTML = '<div class="text-center text-slate-600 text-[10px] italic py-4">Sem registros recentes.</div>';
                }
            } catch (e) { 
                console.error(e);
                div.innerHTML = '<div class="text-center text-red-500 text-[10px] py-4">Erro de conex칚o.</div>';
            }
        }

        async function acaoLimparHistorico() {
            if(!confirm("MESTRE: Tem certeza que deseja apagar todo o hist칩rico?")) return;
            
            const btn = document.getElementById('btnLimparHist');
            const textoOriginal = btn.innerHTML;
            btn.innerHTML = "Apagando...";
            
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "limparHistorico", emailSolicitante: GLOBAL_CURRENT_CHAR_EMAIL })
                });
                carregarHistorico();
            } catch(e) { 
                alert("Erro ao conectar com servidor."); 
            } finally {
                btn.innerHTML = textoOriginal;
            }
        }

        function irParaGrid() {
   	 // Pega o nome do personagem que est치 sendo exibido na tela
    	const charName = document.getElementById('charNameDisplay').innerText;
    
    	// Se o nome for v치lido usa ele, sen칚o usa o email do jogador
   	     const playerParam = (charName && charName !== "...") ? encodeURIComponent(charName) : encodeURIComponent(GLOBAL_CURRENT_CHAR_EMAIL);
    
   	 // Abre a p치gina do grid em uma nova aba passando a identidade
   	     window.open(`grid.html?player=${playerParam}`, '_blank');
}

    </script>
</body>
</html>
